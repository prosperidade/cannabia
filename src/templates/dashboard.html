<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard de Mensagens - Cannab'IA</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body { font-family: Arial, sans-serif; padding: 20px; }
      table { border-collapse: collapse; width: 100%; margin-top: 20px; }
      th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
      th { background-color: #f4f4f4; }
      .charts { display: grid; grid-template-columns: 1fr; gap: 24px; margin-top: 20px; }
      .chart-card { border: 1px solid #eee; padding: 16px; border-radius: 8px; }
      form { margin-bottom: 12px; }
      input, button { padding: 8px; }
    </style>
  </head>
  <body>
    <h1>Dashboard de Mensagens</h1>

    <form method="GET" action="/dashboard">
      <label for="sender">Filtrar por remetente:</label>
      <input id="sender" name="sender" value="{{ sender_filter or '' }}" />
      <button type="submit">Filtrar</button>
    </form>

    <div class="charts">
      <div class="chart-card">
        <h2>Mensagens por contato</h2>
        <canvas id="messagesChart"></canvas>
      </div>
      <div class="chart-card">
        <h2>Evolução de mensagens por dia</h2>
        <canvas id="lineChart"></canvas>
      </div>
    </div>

    <h2>Mensagens recebidas</h2>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Remetente</th>
          <th>Contato</th>
          <th>Mensagem</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody>
        {% if messages %}
          {% for msg in messages %}
          <tr>
            <td>{{ msg.id }}</td>
            <td>{{ msg.sender }}</td>
            <td>{{ msg.contact_name }}</td>
            <td>{{ msg.message_text }}</td>
            <td>{{ msg.timestamp }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="5">Nenhuma mensagem encontrada.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>

    <script>
      const barLabels = {{ labels | tojson }};
      const barCounts = {{ counts | tojson }};
      const lineLabels = {{ line_labels | tojson }};
      const lineData = {{ line_data | tojson }};

      new Chart(document.getElementById('messagesChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: barLabels,
          datasets: [{
            label: 'Quantidade de Mensagens',
            data: barCounts,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1,
          }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });

      new Chart(document.getElementById('lineChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: lineLabels,
          datasets: [{
            label: 'Mensagens por dia',
            data: lineData,
            borderColor: 'rgba(255, 99, 132, 1)',
            tension: 0.1,
            fill: false,
          }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });
    </script>
  </body>
</html>
